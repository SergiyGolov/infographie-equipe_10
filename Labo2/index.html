<!DOCTYPE>
<html lang="fr">

<head>
  <meta charset="utf-8" />
  <link rel="stylesheet" href="css/stylesheet.css" />

  <!-- WEBGL SCRIPTS -->
  <script src="js/commonFunctions.js"></script>
  <script src="js/gl-matrix-min.js"></script>
  <script src="js/webglTools.js"></script>

  <!-- Our lavalamp script -->
  <script src="js/labo2.js"></script>

</head>

<body onload="initWebGL()">
  <canvas id="webgl-canvas" width="400" height="600">
    HTML5 is not supported
  </canvas>
</body>

<script id="shader-vs" type="x-shader/x-vertex">
      attribute vec3 aVertexPosition;

      uniform mat4 uMVMatrix;
      uniform mat4 uPMatrix;

      void main(void) {
          gl_Position = uPMatrix * uMVMatrix * vec4(aVertexPosition, 1.0);
      }
    </script>
<script id="shader-fs" type="x-shader/x-fragment">
      #ifdef GL_ES
            precision highp float;
      #endif

      const int NB_METABALLS=15;
      float SQUEEZE_MAX=250.0;


      uniform vec4 uMetaballs[NB_METABALLS];
      uniform float uMetaballsSqueezes[NB_METABALLS];
      uniform vec2 uLight;

      float WIDTH=200.0;
      float HEIGHT=600.0;


      void main()
      {
            float x = gl_FragCoord.x;
            float y = gl_FragCoord.y;

            if (abs(x - uLight.x) < WIDTH && abs(y - uLight.y) < HEIGHT)
            {
                  float v = 0.0;
                  
                  for (int i = 0; i < NB_METABALLS; i++) {
                        
                        vec4 mb = uMetaballs[i];
                        float weight = mb.w;
                        float squeeze = uMetaballsSqueezes[i];
                        float dx = mb.x - x;
                        float dy = mb.y - y;
                        float r = mb.z;
                        float SQUEEZE_Y_TRANSLATE=r/23.0;
                        if(squeeze>0.0 && squeeze<SQUEEZE_MAX/2.0)
                        {
                              dx/=(SQUEEZE_MAX/(SQUEEZE_MAX-squeeze));      
                              dy+=r*squeeze/SQUEEZE_MAX;       
                              dy*=(SQUEEZE_MAX/(SQUEEZE_MAX-squeeze));
                              
                              

                        }else if(squeeze>0.0 && squeeze>=SQUEEZE_MAX/2.0)
                        {
                              dx/=(SQUEEZE_MAX/squeeze);
                              dy+=r*(1.0-squeeze/SQUEEZE_MAX);       ;
                              dy*=(SQUEEZE_MAX/squeeze);
                              
                        }

                        v += weight*r*r/(dx*dx + dy*dy);
                  }

                  vec2  ray = vec2(x - uLight.x, y - uLight.y);
                  float luminosity = sqrt(ray.x * ray.x + ray.y * ray.y);
                  if (v >= 2.0)
                  {
                        gl_FragColor = vec4(250.0/luminosity, 0.0, 0.0, 1.0);
                  } else {
                        gl_FragColor = vec4(100.0/luminosity, 50.0/luminosity, 0.0, 0.5);
                  }
            }
      }
      </script>
</html>
